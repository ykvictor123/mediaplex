<html><head><base href="."><script src="https://unpkg.com/@popperjs/core@2"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"><title>MediaPlex - Tu Servidor Multimedia</title><style>
:root {
    --primary-color: #e5a00d;
    --secondary-color: #282828;
    --background-dark: #1f1f1f;
    --text-light: #ffffff;
}

body {
    background: var(--background-dark);
    color: var(--text-light);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.sidebar {
    background: var(--secondary-color);
    min-height: 100vh;
    padding: 1rem;
}

.main-content {
    padding: 2rem;
}

.media-card {
    background: var(--secondary-color);
    border-radius: 8px;
    transition: transform 0.2s;
    cursor: pointer;
    height: 300px; /* Fixed height */
    position: relative;
    display: flex;
    flex-direction: column;
}

.media-card:hover {
    transform: scale(1.02);
}

.media-thumbnail {
    position: relative;
    height: 100%; /* Fill parent height */
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    overflow: hidden;
}

.media-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.5rem;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    transition: opacity 0.3s;
    max-height: 30%;
    overflow-y: auto;
}

.media-overlay h5 {
    margin-bottom: 0.15rem; /* Reduced margin */
    font-size: 0.9rem; /* Slightly smaller font */
}

.media-overlay p {
    margin-bottom: 0.1rem; /* Reduced margin */
    font-size: 0.75rem; /* Smaller font */
    opacity: 0.8;
}

.media-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0;
    transition: opacity 0.3s;
    display: flex;
    gap: 0.5rem;
}

.media-card:hover .media-actions {
    opacity: 1;
}

.login-container {
    background: var(--secondary-color);
    border-radius: 10px;
    padding: 2rem;
}

.btn-primary {
    background: var(--primary-color);
    border: none;
}

.btn-primary:hover {
    background: #c78c0b;
}

.btn-secondary {
    background: #6c757d;
}

.btn-secondary:hover {
    background: #5a6268;
}

.navbar {
    background: var(--secondary-color);
}

.search-bar {
    background: rgba(255,255,255,0.1);
    border: none;
    color: var(--text-light);
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
}

.progress-bar {
    background-color: var(--primary-color);
}

.add-content-btn {
    position: absolute;
    right: 1rem;
    top: 0.5rem;
}

.collapse {
    border-top: 1px solid rgba(255,255,255,0.1);
}

.collapse .btn-group .btn {
    padding: 0.2rem 0.4rem;
}

.toast-container {
    z-index: 1050;
}
</style>
<script>
class ContentManager {
    constructor() {
        this.movies = JSON.parse(localStorage.getItem('movies') || '[]');
        this.series = JSON.parse(localStorage.getItem('series') || '[]');
        this.TMDB_API_KEY = '708a2826cbb3c7dbd79b10c569049f54';
        this.TMDB_BASE_URL = 'https://api.themoviedb.org/3';

        setTimeout(() => {
            this.setupTabHandlers();
            this.showSection('movies');
            this.renderContent('movies');
        }, 0);
    }

    setupTabHandlers() {
        const sidebarLinks = document.querySelectorAll('.sidebar .btn-link');
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.currentTarget.getAttribute('data-section');
                this.showSection(section);
            });
        });
    }

    normalizeTitle(title) {
        if (!title) return '';
        return title
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "") 
            .replace(/[^a-z0-9\s]/g, "") 
            .replace(/\s+/g, " ") 
            .trim();
    }

    async showAddContentModal(section) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">Agregar ${this.getSectionName(section)}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addContentForm">
                            <div class="mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="useManualTitle">
                                    <label class="form-check-label" for="useManualTitle">
                                        Usar título manual
                                    </label>
                                </div>
                                <div id="manualTitleInputs" style="display: none;">
                                    <input type="text" class="form-control bg-secondary text-light mb-2" 
                                           name="manualTitle" placeholder="Título">
                                    <input type="text" class="form-control bg-secondary text-light mb-2" 
                                           name="manualYear" placeholder="Año (opcional)">
                                    <input type="text" class="form-control bg-secondary text-light mb-2" 
                                           name="manualQuality" placeholder="Calidad (ej: 1080p)">
                                    <input type="text" class="form-control bg-secondary text-light" 
                                           name="manualLanguage" placeholder="Idioma">
                                </div>
                            </div>
                            ${section === 'series' ? `
                                <div class="mb-3">
                                    <label class="form-label">Nombre de la Serie</label>
                                    <input type="text" class="form-control bg-secondary text-light" name="seriesName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Temporada</label>
                                    <input type="number" class="form-control bg-secondary text-light" name="season" required min="1">
                                </div>
                            ` : ''}
                            <div class="mb-3">
                                <label class="form-label">Código iframe</label>
                                <textarea class="form-control bg-secondary text-light" name="iframe" rows="5" required></textarea>
                                <small class="text-muted">Puedes pegar varios iframes, uno por línea</small>
                            </div>
                            <div id="metadataPreview" class="mb-3" style="display: none;">
                                <h6>Metadatos detectados:</h6>
                                <div class="metadata-content"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </form>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
        
        const useManualTitleCheckbox = modal.querySelector('#useManualTitle');
        const manualTitleInputs = modal.querySelector('#manualTitleInputs');
        useManualTitleCheckbox.addEventListener('change', (e) => {
            manualTitleInputs.style.display = e.target.checked ? 'block' : 'none';
        });
        
        const form = modal.querySelector('form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const iframeCodes = e.target.iframe.value.split('\n').filter(code => code.trim());
            
            const addedContent = [];
            const skippedContent = [];
            
            for (const iframeCode of iframeCodes) {
                let content;
                if (useManualTitleCheckbox.checked) {
                    content = {
                        title: e.target.manualTitle.value,
                        year: e.target.manualYear.value,
                        quality: e.target.manualQuality.value,
                        language: e.target.manualLanguage.value,
                        iframe: iframeCode,
                        thumbnail: 'https://via.placeholder.com/300x450'
                    };
                    
                    const isDuplicate = this.movies.some(existingItem => {
                        const existingUrl = this.extractIframeUrl(existingItem.iframe);
                        const newUrl = this.extractIframeUrl(iframeCode);
                        return existingUrl === newUrl;
                    });
                    
                    if (!isDuplicate) {
                        this.movies.push(content);
                        addedContent.push(content.title);
                    } else {
                        skippedContent.push(content.title);
                    }
                } else {
                    content = await this.extractMetadata(iframeCode);
                    if (content) {
                        const isDuplicate = this.movies.some(item => {
                            const existingUrl = this.extractIframeUrl(item.iframe);
                            const newUrl = this.extractIframeUrl(iframeCode);
                            return existingUrl === newUrl;
                        });
                        
                        if (!isDuplicate) {
                            try {
                                const searchQuery = encodeURIComponent(content.searchTitle || content.title);
                                const response = await fetch(
                                    `${this.TMDB_BASE_URL}/search/movie?api_key=${this.TMDB_API_KEY}&query=${searchQuery}&language=es-ES${content.year ? `&year=${content.year}` : ''}`
                                );
                                const data = await response.json();
                                
                                if (data.results && data.results.length > 0) {
                                    const selectedMetadata = await this.showMovieSelectionDialog(content);
                                    if (selectedMetadata) {
                                        this.movies.push({
                                            ...content,
                                            ...selectedMetadata
                                        });
                                        addedContent.push(content.title);
                                    }
                                } else {
                                    this.movies.push(content);
                                    addedContent.push(content.title);
                                }
                            } catch (error) {
                                console.error('Error fetching movie data:', error);
                                this.movies.push(content);
                                addedContent.push(content.title);
                            }
                        } else {
                            skippedContent.push(content.title);
                        }
                    }
                }
            }
            
            localStorage.setItem(section, JSON.stringify(this[section]));
            this.renderContent(section);
            modalInstance.hide();
            modal.remove();

            if (addedContent.length > 0 || skippedContent.length > 0) {
                let message = '';
                if (addedContent.length > 0) {
                    message += `Agregado: ${addedContent.join(', ')}\n`;
                }
                if (skippedContent.length > 0) {
                    message += `Omitido: ${skippedContent.join(', ')} (duplicados)`;
                }
                this.showToast(message, 'info');
            }
        });
        
        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }

    async showMovieSelectionDialog(content) {
        return new Promise(async (resolve) => {
            const searchQuery = encodeURIComponent(content.title);
            try {
                const response = await fetch(
                    `${this.TMDB_BASE_URL}/search/movie?api_key=${this.TMDB_API_KEY}&query=${searchQuery}&language=es-ES${content.year ? `&year=${content.year}` : ''}`
                );
                const data = await response.json();

                const modalId = Date.now();
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content bg-dark">
                            <div class="modal-header">
                                <h5 class="modal-title">Seleccionar película correcta para: ${content.title}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${data.results && data.results.length > 0 ? `
                                    <div class="row">
                                        ${data.results.slice(0, 6).map((movie) => `
                                            <div class="col-md-4 mb-3">
                                                <div class="card bg-secondary h-100">
                                                    <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" 
                                                        class="card-img-top" 
                                                        alt="${movie.title}"
                                                        onerror="this.src='https://via.placeholder.com/300x450'">
                                                    <div class="card-body">
                                                        <h6 class="card-title">${movie.title}</h6>
                                                        <p class="card-text small">
                                                            Año: ${movie.release_date?.substring(0, 4) || 'N/A'}<br>
                                                            Puntuación: ${movie.vote_average}/10
                                                        </p>
                                                        <button class="btn btn-primary btn-sm" 
                                                                onclick="contentManager.selectMovie(${movie.id}, '${modalId}')">
                                                            Seleccionar
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="alert alert-warning">
                                        No se encontraron resultados para: ${content.title}
                                    </div>
                                `}
                                <div class="text-center mt-3">
                                    <button class="btn btn-secondary" onclick="contentManager.skipMovieSelection('${modalId}')">
                                        Mantener datos actuales
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                const modalInstance = new bootstrap.Modal(modal);
                
                this.movieSelectionCallbacks = this.movieSelectionCallbacks || {};
                this.movieSelectionCallbacks[modalId] = {
                    resolve,
                    content,
                    modal,
                    modalInstance
                };
                modalInstance.show();
            } catch (error) {
                console.error('Error fetching movie data:', error);
                resolve(content);
            }
        });
    }

    async scanLibrary(section, specificIndex = null) {
        try {
            const items = specificIndex !== null ? 
                [this[section][specificIndex]] :
                this[section].filter(item => {
                    return !item.genres || !item.overview || !item.rating || !item.cast || !item.director;
                });

            if (items.length === 0) {
                this.showToast('No hay elementos con metadata incompleta', 'info');
                return;
            }

            const updateToast = this.showToast('Actualizando metadata...', 'info');
            let updatedCount = 0;

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const selectedMetadata = await this.showMovieSelectionDialog(item);
                
                if (selectedMetadata && selectedMetadata !== item) {
                    const index = specificIndex !== null ? specificIndex : this[section].indexOf(item);
                    this[section][index] = {
                        ...item,
                        ...selectedMetadata
                    };
                    updatedCount++;
                    this.updateToast(updateToast, `Actualizando... (${updatedCount}/${items.length})`);
                }
            }

            localStorage.setItem(section, JSON.stringify(this[section]));
            this.renderContent(section);
            this.showToast(`Se actualizaron ${updatedCount} elementos`, 'success');
        } catch (error) {
            console.error('Error in scanLibrary:', error);
            this.showToast('Error al escanear la biblioteca', 'error');
        }
    }

    extractIframeUrl(iframeString) {
        if (iframeString.includes('<iframe')) {
            const srcMatch = iframeString.match(/src=["'](.*?)["']/);
            return srcMatch ? srcMatch[1] : '';
        }
        return iframeString.trim();
    }

    async extractMetadata(iframeCode) {
        try {
            const parts = iframeCode.split('|').map(part => part.trim());
            let title = parts[0] || '';
            const iframeSrc = parts[1] || iframeCode;

            const qualityMatch = title.match(/\b(?:1080p|720p|2160p|4K|HDR|60FPS|BRRIP|BDRIP|WEB-DL|TELESYNC)\b/i);
            const quality = qualityMatch ? qualityMatch[0].toUpperCase() : '';
            title = title.replace(/\b(?:1080p|720p|2160p|4K|HDR|60FPS|BRRIP|BDRIP|WEB-DL|TELESYNC)\b/gi, '');

            const languageMatch = title.match(/\b(?:Latino[- ]Inglés|Castellano|Dual|Español)\b/i);
            const language = languageMatch ? languageMatch[0] : '';
            title = title.replace(/\b(?:Latino[- ]Inglés|Castellano|Dual|Español)\b/gi, '');

            const yearMatch = title.match(/[\[\(]?(19|20)\d{2}[\]\)]?/);
            const year = yearMatch ? yearMatch[0].replace(/[\[\]()]/g, '') : '';
            title = title.replace(/[\[\(]?(19|20)\d{2}[\]\)]?/, '');

            title = title.replace(/\.(mkv|mp4|avi|mov|flv|wmv)$/i, '');

            title = title.replace(/\b(?:VERSIÓN|VERSION)\s+(?:PESADA|LIGERA|COMPLETA)\b/gi, '')
                        .replace(/\[.*?(?:KARPEZSTUDIO|vip\.hdlatino\.us).*?\]/gi, '')
                        .replace(/cinecalidad(?:\.la)?/gi, '')
                        .replace(/\bx265\b/gi, '')
                        .replace(/full/gi, '')
                        .replace(/\b(?:V\d|LÍNEA|LINE)\b/gi, '');

            title = title.replace(/[\[\(].*?[\]\)]/g, '')
                        .replace(/\./g, ' ')
                        .replace(/\s+/g, ' ')
                        .replace(/[._-]/g, ' ')
                        .trim();

            const searchTitle = title.replace(/\b(?:4K|HDR|EXTENDED|THEATRICAL|CUT|UNRATED)\b/gi, '')
                                    .trim();

            return {
                title: title,
                searchTitle: searchTitle,
                year: year,
                quality: quality,
                language: language,
                iframe: iframeSrc,
                thumbnail: 'https://via.placeholder.com/300x450'
            };
        } catch (error) {
            console.error('Error extracting metadata:', error);
            return null;
        }
    }

    async selectMovie(movieId, modalId) {
        try {
            const response = await fetch(
                `${this.TMDB_BASE_URL}/movie/${movieId}?api_key=${this.TMDB_API_KEY}&append_to_response=credits&language=es-ES`
            );
            const movieData = await response.json();
            
            const metadata = {
                title: movieData.title,
                year: movieData.release_date?.substring(0, 4),
                thumbnail: movieData.poster_path ? 
                          `https://image.tmdb.org/t/p/w500${movieData.poster_path}` : 'https://via.placeholder.com/300x450',
                genres: movieData.genres.map(g => g.name),
                overview: movieData.overview,
                rating: movieData.vote_average,
                runtime: movieData.runtime,
                cast: movieData.credits?.cast?.slice(0, 5).map(actor => actor.name),
                director: movieData.credits?.crew?.find(p => p.job === 'Director')?.name
            };

            const callback = this.movieSelectionCallbacks[modalId];
            if (callback) {
                const modal = callback.modal;
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
                modal.remove();
                callback.resolve(metadata);
                delete this.movieSelectionCallbacks[modalId];
            }
        } catch (error) {
            console.error('Error fetching movie details:', error);
            this.skipMovieSelection(modalId);
        }
    }

    async skipMovieSelection(modalId) {
        const callback = this.movieSelectionCallbacks[modalId];
        if (callback) {
            const modal = callback.modal;
            const modalInstance = bootstrap.Modal.getInstance(modal);
            modalInstance.hide();
            modal.remove();
            callback.resolve(callback.content);
            delete this.movieSelectionCallbacks[modalId];
        }
    }

    cleanTitle(title) {
        return title
            .replace(/\.[^/.]+$/, '')
            .replace(/\b(19|20)\d{2}\b/, '')
            .replace(/\b\d{3,4}p\b/i, '')
            .replace(/\b(dual-lat|latino|castellano)\b/i, '')
            .replace(/\[.*?\]/g, '')
            .replace(/\.(mp4|mkv|avi)$/i, '')
            .replace(/\./g, ' ')
            .replace(/\s+/g, ' ')
            .replace(/cinecalidad(\.la)?/i, '')
            .trim();
    }

    normalizeTitle(title) {
        if (!title) return '';
        return title
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "") 
            .replace(/[^a-z0-9\s]/g, "") 
            .replace(/\s+/g, " ") 
            .trim();
    }

    getSectionName(section) {
        const names = {
            movies: 'Película',
            series: 'Serie',
            music: 'Música',
            photos: 'Foto'
        };
        return names[section] || section;
    }

    showSection(sectionId) {
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
        });
        const targetSection = document.querySelector(`#${sectionId}-section`);
        if (targetSection) {
            targetSection.style.display = 'block';
        }
    }

    renderContent(section) {
        const container = document.querySelector(`#${section}-section .row`);
        const items = this[section] || [];
        
        // Update section title with count
        const sectionTitle = document.querySelector(`#${section}-section h4`);
        if (sectionTitle) {
            const countBadge = document.createElement('span');
            countBadge.className = 'badge bg-primary ms-2';
            countBadge.textContent = items.length;
            
            // Remove existing badge if any
            const existingBadge = sectionTitle.nextElementSibling;
            if (existingBadge && existingBadge.classList.contains('badge')) {
                existingBadge.remove();
            }
            
            sectionTitle.parentNode.insertBefore(countBadge, sectionTitle.nextSibling);
        }

        const existingActionButtons = document.querySelector(`#${section}-section .d-flex.gap-2`);
        if (existingActionButtons) {
            const bulkDeleteBtn = existingActionButtons.querySelector('.btn-danger');
            if (bulkDeleteBtn) {
                bulkDeleteBtn.remove();
            }
        }
        
        const actionButtons = document.querySelector(`#${section}-section .d-flex.gap-2`);
        if (actionButtons && items.length > 0 && !actionButtons.querySelector('.btn-danger')) {
            const bulkDeleteBtn = document.createElement('button');
            bulkDeleteBtn.className = 'btn btn-danger';
            bulkDeleteBtn.innerHTML = '<i class="fas fa-trash me-2"></i>Eliminar seleccionados';
            bulkDeleteBtn.onclick = () => this.deleteBulkContent(section);
            actionButtons.appendChild(bulkDeleteBtn);
        }

        if (section === 'movies') {
            container.innerHTML = items.length === 0 ? `
                <div class="alert alert-info w-100">
                    <i class="fas fa-info-circle me-2"></i>No hay películas disponibles.
                </div>
            ` : `
                <div class="row g-4">
                    ${items.map((item, index) => `
                        <div class="col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2 mb-4">
                            <div class="media-card position-relative">
                                <div class="form-check position-absolute top-0 start-0 m-2 z-3">
                                    <input class="form-check-input" type="checkbox" value="${index}" 
                                           data-bulk-delete>
                                </div>
                                <div class="media-thumbnail" style="background-image: url('${item.thumbnail || 'https://via.placeholder.com/300x450'}')"
                                     onclick="contentManager.playContent('${section}', ${index})">
                                    <div class="media-overlay">
                                        <h5 class="text-truncate">${item.title}</h5>
                                        ${item.year ? `<p>Año: ${item.year}</p>` : ''}
                                        ${item.genres ? `<p>Géneros: ${item.genres.slice(0, 2).join(', ')}${item.genres.length > 2 ? '...' : ''}</p>` : ''}
                                    </div>
                                    <div class="media-actions">
                                        <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); contentManager.editContent('${section}', ${index})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); contentManager.deleteContent('${section}', ${index})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            // Original series rendering code...
        }
    }

    editContent(section, index) {
        const item = this[section][index];
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar ${this.getSectionName(section)}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editContentForm">
                            <div class="mb-3">
                                <label class="form-label">Título</label>
                                <input type="text" class="form-control bg-secondary text-light" 
                                       name="title" value="${item.title || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Año</label>
                                <input type="text" class="form-control bg-secondary text-light" 
                                       name="year" value="${item.year || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Calidad</label>
                                <input type="text" class="form-control bg-secondary text-light" 
                                       name="quality" value="${item.quality || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Idioma</label>
                                <input type="text" class="form-control bg-secondary text-light" 
                                       name="language" value="${item.language || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">URL Thumbnail</label>
                                <input type="url" class="form-control bg-secondary text-light" 
                                       name="thumbnail" value="${item.thumbnail || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Código iframe</label>
                                <textarea class="form-control bg-secondary text-light" 
                                  name="iframe" required>${item.iframe || ''}</textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Guardar cambios</button>
                        </form>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

        const form = modal.querySelector('#editContentForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            
            this[section][index] = {
                ...item,
                title: formData.get('title'),
                year: formData.get('year'),
                quality: formData.get('quality'),
                language: formData.get('language'),
                thumbnail: formData.get('thumbnail'),
                iframe: formData.get('iframe')
            };

            localStorage.setItem(section, JSON.stringify(this[section]));
            this.renderContent(section);
            modalInstance.hide();
            this.showToast('Contenido actualizado correctamente', 'success');
        });

        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }

    deleteContent(section, index) {
        const item = this[section][index];
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmar eliminación</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>¿Estás seguro de que deseas eliminar "${item.title}"?</p>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Esta acción no se puede deshacer.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger" onclick="contentManager.confirmDelete('${section}', ${index})">
                            Eliminar
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }

    confirmDelete(section, index) {
        this[section].splice(index, 1);
        localStorage.setItem(section, JSON.stringify(this[section]));
        this.renderContent(section);
        
        const modal = document.querySelector('.modal');
        const modalInstance = bootstrap.Modal.getInstance(modal);
        modalInstance.hide();
        
        this.showToast('Elemento eliminado correctamente', 'success');
    }

    deleteBulkContent(section) {
        const checkboxes = document.querySelectorAll(`#${section}-section input[data-bulk-delete]:checked`);
        if (checkboxes.length === 0) {
            this.showToast('No hay elementos seleccionados para eliminar', 'warning');
            return;
        }

        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmar eliminación múltiple</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>¿Estás seguro de que deseas eliminar ${checkboxes.length} elementos seleccionados?</p>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Esta acción no se puede deshacer.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger" onclick="contentManager.confirmBulkDelete('${section}')">
                            Eliminar ${checkboxes.length} elementos
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }

    confirmBulkDelete(section) {
        const checkboxes = document.querySelectorAll(`#${section}-section input[data-bulk-delete]:checked`);
        const indexes = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => b - a);
        
        indexes.forEach(index => {
            this[section].splice(index, 1);
        });
        
        localStorage.setItem(section, JSON.stringify(this[section]));
        this.renderContent(section);
        
        const modal = document.querySelector('.modal');
        const modalInstance = bootstrap.Modal.getInstance(modal);
        modalInstance.hide();
        
        this.showToast(`${indexes.length} elementos eliminados correctamente`, 'success');
    }

    async scanLibrary(section, specificIndex = null) {
        try {
            const items = specificIndex !== null ? 
                [this[section][specificIndex]] :
                this[section].filter(item => {
                    return !item.genres || !item.overview || !item.rating || !item.cast || !item.director;
                });

            if (items.length === 0) {
                this.showToast('No hay elementos con metadata incompleta', 'info');
                return;
            }

            const updateToast = this.showToast('Actualizando metadata...', 'info');
            let updatedCount = 0;

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const selectedMetadata = await this.showMovieSelectionDialog(item);
                
                if (selectedMetadata && selectedMetadata !== item) {
                    const index = specificIndex !== null ? specificIndex : this[section].indexOf(item);
                    this[section][index] = {
                        ...item,
                        ...selectedMetadata
                    };
                    updatedCount++;
                    this.updateToast(updateToast, `Actualizando... (${updatedCount}/${items.length})`);
                }
            }

            localStorage.setItem(section, JSON.stringify(this[section]));
            this.renderContent(section);
            this.showToast(`Se actualizaron ${updatedCount} elementos`, 'success');
        } catch (error) {
            console.error('Error in scanLibrary:', error);
            this.showToast('Error al escanear la biblioteca', 'error');
        }
    }

    playContent(section, index) {
        const item = this[section][index];
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark">
                    <div class="modal-header border-0">
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-md-12">
                                    <div style="background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.3) 100%), url('${item.thumbnail}') no-repeat center/cover; height: 40vh; position: relative;">
                                        <div class="position-absolute bottom-0 start-0 p-4 text-white">
                                            <h2 class="fw-bold mb-2">${item.title}</h2>
                                            <div class="d-flex align-items-center gap-3 mb-3">
                                                ${item.year ? `<span class="badge bg-light text-dark">${item.year}</span>` : ''}
                                                ${item.quality ? `<span class="badge bg-primary">${item.quality}</span>` : ''}
                                                ${item.language ? `<span class="badge bg-secondary">${item.language}</span>` : ''}
                                                ${item.rating ? `<span class="badge bg-warning text-dark"><i class="fas fa-star me-1"></i>${item.rating}/10</span>` : ''}
                                            </div>
                                            <p class="mb-3">${item.overview || 'No hay descripción disponible.'}</p>
                                            <div class="d-flex gap-2 mb-3">
                                                <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#playerCollapse">
                                                    <i class="fas fa-play me-2"></i>Reproducir
                                                </button>
                                                <button class="btn btn-secondary" onclick="contentManager.scanLibrary('${section}', ${index})">
                                                    <i class="fas fa-sync me-2"></i>Actualizar Metadata
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="collapse" id="playerCollapse">
                                        <div class="card card-body bg-black">
                                            <div class="ratio ratio-16x9">
                                                ${this.createIframe(item.iframe)}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-3">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="d-flex flex-wrap gap-2 mb-3">
                                                    ${item.genres ? item.genres.map(genre => 
                                                        `<span class="badge bg-secondary">${genre}</span>`
                                                    ).join('') : ''}
                                                </div>
                                                ${item.cast ? `
                                                    <small class="d-block text-muted mb-2">
                                                        <strong>Reparto:</strong> ${item.cast.join(', ')}
                                                    </small>
                                                ` : ''}
                                                ${item.director ? `
                                                    <small class="d-block text-muted mb-2">
                                                        <strong>Director:</strong> ${item.director}
                                                    </small>
                                                ` : ''}
                                                ${item.runtime ? `
                                                    <small class="d-block text-muted">
                                                        <strong>Duración:</strong> ${item.runtime} minutos
                                                    </small>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }

    createIframe(iframeUrl) {
        if (iframeUrl.toLowerCase().includes('<iframe')) {
            return iframeUrl;
        }
        return `<iframe src="${iframeUrl}" 
                        allowfullscreen="true"
                        frameborder="0" 
                        scrolling="no" 
                        style="width: 100%; height: 100%;"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                </iframe>`;
    }

    showToast(message, type = 'info') {
        const toastContainer = document.querySelector('.toast-container') || this.createToastContainer();
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
        
        return bsToast;
    }

    createToastContainer() {
        const container = document.createElement('div');
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
        return container;
    }

    updateToast(toast, message) {
        if (toast) {
            const toastBody = toast._element.querySelector('.toast-body');
            if (toastBody) {
                toastBody.textContent = message;
            }
        }
    }
}
document.addEventListener('DOMContentLoaded', () => {
    window.contentManager = new ContentManager();
});
</script>
</head><body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-play-circle text-warning"></i> MediaPlex
            </a>
            <div class="d-flex align-items-center">
                <input type="search" class="form-control search-bar me-2" placeholder="Buscar contenido...">
                <div class="dropdown">
                    <img src="https://via.placeholder.com/40" alt="Avatar de usuario" class="user-avatar" role="button" data-bs-toggle="dropdown">
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Perfil</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Configuración</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt me-2"></i>Cerrar sesión</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 sidebar">
                <div class="d-flex flex-column">
                    <h6 class="text-uppercase text-muted mb-3">BIBLIOTECA</h6>
                    <a href="#" class="btn btn-link text-light text-start mb-2" data-section="movies"><i class="fas fa-film me-2"></i>Películas</a>
                    <a href="#" class="btn btn-link text-light text-start mb-2" data-section="series"><i class="fas fa-tv me-2"></i>Series</a>
                    <a href="#" class="btn btn-link text-light text-start mb-2" data-section="music"><i class="fas fa-music me-2"></i>Música</a>
                    <a href="#" class="btn btn-link text-light text-start mb-2" data-section="photos"><i class="fas fa-image me-2"></i>Fotos</a>
                    
                    <h6 class="text-uppercase text-muted mb-3 mt-4">ADMINISTRACIÓN</h6>
                    <a href="#" class="btn btn-link text-light text-start mb-2" data-section="users"><i class="fas fa-users me-2"></i>Usuarios</a>
                    <a href="#" class="btn btn-link text-light text-start mb-2" data-section="system"><i class="fas fa-server me-2"></i>Sistema</a>
                </div>
            </div>

            <div class="col-md-10 main-content">
                <div id="movies-section" class="content-section">
                    <div class="position-relative mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
                                <h4>Películas</h4>
                                <span class="badge bg-primary">${this.movies.length}</span>
                            </div>
                            <div class="d-flex gap-2">
                                <div class="dropdown">
                                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-sort"></i> Ordenar
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.sortContent('movies', 'title', 'asc')">Título A-Z</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.sortContent('movies', 'title', 'desc')">Título Z-A</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.sortContent('movies', 'year', 'desc')">Año más reciente</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.sortContent('movies', 'year', 'asc')">Año más antiguo</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.sortContent('movies', 'rating', 'desc')">Mejor valoradas</a></li>
                                    </ul>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-filter"></i> Filtrar
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.filterContent('movies', 'all')">Todas</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.filterContent('movies', 'incomplete')">Metadata incompleta</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">Calidad</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.filterContent('movies', 'quality', '1080p')">1080p</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.filterContent('movies', 'quality', '720p')">720p</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">Idioma</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.filterContent('movies', 'language', 'Latino')">Latino</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.filterContent('movies', 'language', 'Castellano')">Castellano</a></li>
                                    </ul>
                                </div>
                                <button class="btn btn-primary" onclick="contentManager.showAddContentModal('movies')">
                                    <i class="fas fa-plus me-2"></i>Agregar Película
                                </button>
                                <button class="btn btn-secondary" onclick="contentManager.scanLibrary('movies', null, false)">
                                    <i class="fas fa-sync me-2"></i>Actualizar incompletas
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4">
                        <div class="alert alert-info w-100">
                            <i class="fas fa-info-circle me-2"></i>No hay películas disponibles.
                        </div>
                    </div>
                </div>

                <div id="series-section" class="content-section" style="display: none;">
                    <div class="position-relative">
                        <h4 class="mb-4">Series</h4>
                        <button class="btn btn-primary add-content-btn" onclick="contentManager.showAddContentModal('series')">
                            <i class="fas fa-plus me-2"></i>Agregar Serie
                        </button>
                        <button class="btn btn-secondary add-content-btn me-5" onclick="contentManager.scanLibrary('series', null, true)">
                            <i class="fas fa-sync me-2"></i>Actualizar series incompletas
                        </button>
                    </div>
                    <div class="row g-4">
                        <div class="row g-4">
                            <div class="col-md-3 mb-4">
                                <div class="media-card" onclick="contentManager.showSeriesEpisodes('Serie 1')">
                                    <div class="media-thumbnail" style="background-image: url('https://via.placeholder.com/300x450')">
                                        <div class="media-overlay">
                                            <h5 class="text-truncate">Serie 1</h5>
                                            <p>Año: 2022</p>
                                            <p>Géneros: Acción, Aventuras</p>
                                            <p>Episodios: 10</p>
                                        </div>
                                        <div class="media-actions">
                                            <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); contentManager.editSeries('Serie 1')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); contentManager.deleteSeries('Serie 1')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info w-100">
                        <i class="fas fa-info-circle me-2"></i>No hay series disponibles.
                    </div>
                </div>

                <div id="music-section" class="content-section" style="display: none;">
                    <h4 class="mb-4">Música</h4>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No hay música disponible actualmente.
                    </div>
                </div>

                <div id="photos-section" class="content-section" style="display: none;">
                    <h4 class="mb-4">Fotos</h4>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No hay fotos disponibles actualmente.
                    </div>
                </div>

                <div id="users-section" class="content-section" style="display: none;">
                    <h4 class="mb-4">Gestión de Usuarios</h4>
                    <div class="card bg-secondary">
                        <div class="card-body">
                            <h5 class="mb-3">Usuarios Registrados</h5>
                            <div class="table-responsive">
                                <table class="table table-dark">
                                    <thead>
                                        <tr>
                                            <th>Usuario</th>
                                            <th>Rol</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Admin</td>
                                            <td><span class="badge bg-danger">Administrado</span></td>
                                            <td><span class="badge bg-success">Activo</span></td>
                                            <td>
                                                <button class="btn btn-sm btn-warning"><i class="fas fa-edit"></i></button>
                                                <button class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="system-section" class="content-section" style="display: none;">
                    <h4 class="mb-4">Estado del Sistema</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-secondary mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Uso de Recursos</h5>
                                    <p>CPU: 12%</p>
                                    <p>Memoria: 4.2GB / 16GB</p>
                                    <p>Almacenamiento: 756GB / 2TB</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-secondary">
                                <div class="card-body">
                                    <h5 class="card-title">Información del Servidor</h5>
                                    <p>Versión: 1.0.0</p>
                                    <p>Tiempo activo: 24 días</p>
                                    <p>Última actualización: 2024-02-15</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body></html>