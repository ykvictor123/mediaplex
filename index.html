<html><head><base href="."><script src="https://unpkg.com/@popperjs/core@2"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"><title>MediaPlex - Tu Servidor Multimedia</title><style>
:root {
    --primary-color: #e5a00d;
    --secondary-color: #282828;
    --background-dark: #1f1f1f;
    --text-light: #ffffff;
}

body {
    background: var(--background-dark);
    color: var(--text-light);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.sidebar {
    background: var(--secondary-color);
    min-height: 100vh;
    padding: 1rem;
}

.main-content {
    padding: 2rem;
}

.media-card {
    background: var(--secondary-color);
    border-radius: 8px;
    transition: transform 0.2s;
    cursor: pointer;
    height: 100%;
}

.media-card:hover {
    transform: scale(1.02);
}

.media-thumbnail {
    position: relative;
    padding-top: 150%;
    background-size: cover;
    background-position: center;
    border-radius: 8px;
}

.media-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    transition: opacity 0.3s;
}

.media-overlay h5 {
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.media-overlay p {
    margin-bottom: 0.25rem;
    font-size: 0.8rem;
    opacity: 0.8;
}

.media-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0;
    transition: opacity 0.3s;
    display: flex;
    gap: 0.5rem;
}

.media-card:hover .media-actions {
    opacity: 1;
}

.col-md-3 {
    width: 20%;
}

.login-container {
    background: var(--secondary-color);
    border-radius: 10px;
    padding: 2rem;
}

.btn-primary {
    background: var(--primary-color);
    border: none;
}

.btn-primary:hover {
    background: #c78c0b;
}

.btn-secondary {
    background: #6c757d;
}

.btn-secondary:hover {
    background: #5a6268;
}

.navbar {
    background: var(--secondary-color);
}

.search-bar {
    background: rgba(255,255,255,0.1);
    border: none;
    color: var(--text-light);
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
}

.progress-bar {
    background-color: var(--primary-color);
}

.add-content-btn {
    position: absolute;
    right: 1rem;
    top: 0.5rem;
}

.add-content-btn.me-5 {
    right: 6rem;
}

.collapse {
    border-top: 1px solid rgba(255,255,255,0.1);
}

.collapse .btn-group .btn {
    padding: 0.2rem 0.4rem;
}

.toast-container {
    z-index: 1050;
}
</style></head><body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-play-circle text-warning"></i> MediaPlex
            </a>
            <div class="d-flex align-items-center">
                <input type="search" class="form-control search-bar me-2" placeholder="Buscar contenido...">
                <div class="dropdown">
                    <img src="https://via.placeholder.com/40" alt="Avatar de usuario" class="user-avatar" role="button" data-bs-toggle="dropdown">
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Perfil</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Configuración</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt me-2"></i>Cerrar sesión</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 sidebar">
                <div class="d-flex flex-column">
                    <h6 class="text-uppercase text-muted mb-3">BIBLIOTECA</h6>
                    <a href="#" class="btn btn-link text-light text-start mb-2" data-section="movies"><i class="fas fa-film me-2"></i>Películas</a>
                    <a href="#" class="btn btn-link text-light text-start mb-2" data-section="series"><i class="fas fa-tv me-2"></i>Series</a>
                    <a href="#" class="btn btn-link text-light text-start mb-2" data-section="music"><i class="fas fa-music me-2"></i>Música</a>
                    <a href="#" class="btn btn-link text-light text-start mb-2" data-section="photos"><i class="fas fa-image me-2"></i>Fotos</a>
                    
                    <h6 class="text-uppercase text-muted mb-3 mt-4">ADMINISTRACIÓN</h6>
                    <a href="#" class="btn btn-link text-light text-start mb-2" data-section="users"><i class="fas fa-users me-2"></i>Usuarios</a>
                    <a href="#" class="btn btn-link text-light text-start mb-2" data-section="system"><i class="fas fa-server me-2"></i>Sistema</a>
                </div>
            </div>

            <div class="col-md-10 main-content">
                <div id="movies-section" class="content-section">
                    <div class="position-relative mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4>Películas</h4>
                            <div class="d-flex gap-2">
                                <div class="dropdown">
                                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-sort"></i> Ordenar
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.sortContent('movies', 'title', 'asc')">Título A-Z</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.sortContent('movies', 'title', 'desc')">Título Z-A</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.sortContent('movies', 'year', 'desc')">Año más reciente</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.sortContent('movies', 'year', 'asc')">Año más antiguo</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.sortContent('movies', 'rating', 'desc')">Mejor valoradas</a></li>
                                    </ul>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-filter"></i> Filtrar
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.filterContent('movies', 'all')">Todas</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.filterContent('movies', 'incomplete')">Metadata incompleta</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">Calidad</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.filterContent('movies', 'quality', '1080p')">1080p</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.filterContent('movies', 'quality', '720p')">720p</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">Idioma</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.filterContent('movies', 'language', 'Latino')">Latino</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="contentManager.filterContent('movies', 'language', 'Castellano')">Castellano</a></li>
                                    </ul>
                                </div>
                                <button class="btn btn-primary" onclick="contentManager.showAddContentModal('movies')">
                                    <i class="fas fa-plus me-2"></i>Agregar Película
                                </button>
                                <button class="btn btn-secondary" onclick="contentManager.scanLibrary('movies', null, true)">
                                    <i class="fas fa-sync me-2"></i>Actualizar incompletas
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4">
                        <div class="alert alert-info w-100">
                            <i class="fas fa-info-circle me-2"></i>No hay películas disponibles.
                        </div>
                    </div>
                </div>

                <div id="series-section" class="content-section" style="display: none;">
                    <div class="position-relative">
                        <h4 class="mb-4">Series</h4>
                        <button class="btn btn-primary add-content-btn" onclick="contentManager.showAddContentModal('series')">
                            <i class="fas fa-plus me-2"></i>Agregar Serie
                        </button>
                        <button class="btn btn-secondary add-content-btn me-5" onclick="contentManager.scanLibrary('series', null, true)">
                            <i class="fas fa-sync me-2"></i>Actualizar series incompletas
                        </button>
                    </div>
                    <div class="row g-4">
                        <div class="row g-4">
                            <div class="col-md-3 mb-4">
                                <div class="media-card" onclick="contentManager.showSeriesEpisodes('Serie 1')">
                                    <div class="media-thumbnail" style="background-image: url('https://via.placeholder.com/300x450')">
                                        <div class="media-overlay">
                                            <h5 class="text-truncate">Serie 1</h5>
                                            <p>Año: 2022</p>
                                            <p>Géneros: Acción, Aventuras</p>
                                            <p>Episodios: 10</p>
                                        </div>
                                        <div class="media-actions">
                                            <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); contentManager.editSeries('Serie 1')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); contentManager.deleteSeries('Serie 1')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info w-100">
                        <i class="fas fa-info-circle me-2"></i>No hay series disponibles.
                    </div>
                </div>

                <div id="music-section" class="content-section" style="display: none;">
                    <h4 class="mb-4">Música</h4>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No hay música disponible actualmente.
                    </div>
                </div>

                <div id="photos-section" class="content-section" style="display: none;">
                    <h4 class="mb-4">Fotos</h4>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No hay fotos disponibles actualmente.
                    </div>
                </div>

                <div id="users-section" class="content-section" style="display: none;">
                    <h4 class="mb-4">Gestión de Usuarios</h4>
                    <div class="card bg-secondary">
                        <div class="card-body">
                            <h5 class="mb-3">Usuarios Registrados</h5>
                            <div class="table-responsive">
                                <table class="table table-dark">
                                    <thead>
                                        <tr>
                                            <th>Usuario</th>
                                            <th>Rol</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Admin</td>
                                            <td><span class="badge bg-danger">Administrador</span></td>
                                            <td><span class="badge bg-success">Activo</span></td>
                                            <td>
                                                <button class="btn btn-sm btn-warning"><i class="fas fa-edit"></i></button>
                                                <button class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="system-section" class="content-section" style="display: none;">
                    <h4 class="mb-4">Estado del Sistema</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-secondary mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Uso de Recursos</h5>
                                    <p>CPU: 12%</p>
                                    <p>Memoria: 4.2GB / 16GB</p>
                                    <p>Almacenamiento: 756GB / 2TB</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-secondary">
                                <div class="card-body">
                                    <h5 class="card-title">Información del Servidor</h5>
                                    <p>Versión: 1.0.0</p>
                                    <p>Tiempo activo: 24 días</p>
                                    <p>Última actualización: 2024-02-15</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
class ContentManager {
    constructor() {
        this.genres = {
            movies: JSON.parse(localStorage.getItem('movieGenres') || '{}'),
            series: JSON.parse(localStorage.getItem('seriesGenres') || '{}')
        };
        this.currentFilter = { section: null, type: null, value: null };
        this.currentSort = { section: null, field: null, direction: null };
        this.setupTabHandlers();
        this.movies = JSON.parse(localStorage.getItem('movies') || '[]');
        this.series = JSON.parse(localStorage.getItem('series') || '[]');
        this.TMDB_API_KEY = '708a2826cbb3c7dbd79b10c569049f54';
        this.TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        this.showSection('movies');
        this.renderContent('movies');
    }

    setupTabHandlers() {
        const sidebarLinks = document.querySelectorAll('.sidebar .btn-link');
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.currentTarget.getAttribute('data-section');
                this.showSection(section);
            });
        });
    }

    normalizeTitle(title) {
        if (!title) return '';
        return title
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "") 
            .replace(/[^a-z0-9\s]/g, "") 
            .replace(/\s+/g, " ") 
            .trim();
    }

    async showAddContentModal(section) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">Agregar ${this.getSectionName(section)}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addContentForm">
                            <div class="mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="useManualTitle">
                                    <label class="form-check-label" for="useManualTitle">
                                        Usar título manual
                                    </label>
                                </div>
                                <div id="manualTitleInputs" style="display: none;">
                                    <input type="text" class="form-control bg-secondary text-light mb-2" 
                                           name="manualTitle" placeholder="Título">
                                    <input type="text" class="form-control bg-secondary text-light mb-2" 
                                           name="manualYear" placeholder="Año (opcional)">
                                    <input type="text" class="form-control bg-secondary text-light mb-2" 
                                           name="manualQuality" placeholder="Calidad (ej: 1080p)">
                                    <input type="text" class="form-control bg-secondary text-light" 
                                           name="manualLanguage" placeholder="Idioma">
                                </div>
                            </div>
                            ${section === 'series' ? `
                                <div class="mb-3">
                                    <label class="form-label">Nombre de la Serie</label>
                                    <input type="text" class="form-control bg-secondary text-light" name="seriesName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Temporada</label>
                                    <input type="number" class="form-control bg-secondary text-light" name="season" required min="1">
                                </div>
                            ` : ''}
                            <div class="mb-3">
                                <label class="form-label">Código iframe</label>
                                <textarea class="form-control bg-secondary text-light" name="iframe" rows="5" required></textarea>
                                <small class="text-muted">Puedes pegar varios iframes, uno por línea</small>
                            </div>
                            <div id="metadataPreview" class="mb-3" style="display: none;">
                                <h6>Metadatos detectados:</h6>
                                <div class="metadata-content"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </form>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
        
        const useManualTitleCheckbox = modal.querySelector('#useManualTitle');
        const manualTitleInputs = modal.querySelector('#manualTitleInputs');
        useManualTitleCheckbox.addEventListener('change', (e) => {
            manualTitleInputs.style.display = e.target.checked ? 'block' : 'none';
        });
        
        const form = modal.querySelector('form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const iframeCodes = e.target.iframe.value.split('\n').filter(code => code.trim());
            
            const addedContent = [];
            const skippedContent = [];
            
            for (const iframeCode of iframeCodes) {
                let content;
                if (useManualTitleCheckbox.checked) {
                    content = {
                        title: e.target.manualTitle.value,
                        year: e.target.manualYear.value,
                        quality: e.target.manualQuality.value,
                        language: e.target.manualLanguage.value,
                        iframe: iframeCode,
                        thumbnail: 'https://via.placeholder.com/300x450'
                    };
                    
                    const isDuplicate = this.movies.some(existingItem => {
                        if (existingItem.iframe === iframeCode || 
                            existingItem.iframe.includes(iframeCode) || 
                            iframeCode.includes(existingItem.iframe)) {
                            return true;
                        }
                        
                        const normalizedNewTitle = this.normalizeTitle(content.title);
                        const normalizedExistingTitle = this.normalizeTitle(existingItem.title);
                        
                        if (normalizedNewTitle === normalizedExistingTitle) {
                            if (content.year && existingItem.year) {
                                return content.year === existingItem.year;
                            }
                            return true;
                        }
                        
                        return false;
                    });
                    
                    if (!isDuplicate) {
                        this.movies.push(content);
                        addedContent.push(content.title);
                    } else {
                        skippedContent.push(content.title);
                    }
                } else {
                    content = await this.extractMetadata(iframeCode);
                    if (content) {
                        const isDuplicate = this.movies.some(item => 
                            item.iframe === iframeCode || 
                            item.iframe.includes(iframeCode) ||
                            iframeCode.includes(item.iframe) ||
                            (this.normalizeTitle(item.title) === this.normalizeTitle(content.title) &&
                             item.year === content.year &&
                             item.quality === content.quality &&
                             item.language === content.language)
                        );
                        
                        if (!isDuplicate) {
                            try {
                                const searchQuery = encodeURIComponent(content.searchTitle);
                                const response = await fetch(
                                    `${this.TMDB_BASE_URL}/search/movie?api_key=${this.TMDB_API_KEY}&query=${searchQuery}&language=es-ES${content.year ? `&year=${content.year}` : ''}`
                                );
                                const data = await response.json();
                                
                                if (data.results && data.results.length > 0) {
                                    const selectedMetadata = await this.showMovieSelectionDialog(content);
                                    if (selectedMetadata) {
                                        this.movies.push({
                                            ...content,
                                            ...selectedMetadata
                                        });
                                        addedContent.push(content.title);
                                    }
                                }
                            } catch (error) {
                                console.error('Error fetching movie data:', error);
                                this.movies.push(content);
                                addedContent.push(content.title);
                            }
                        } else {
                            skippedContent.push(content.title);
                        }
                    }
                }
            }
            
            localStorage.setItem(section, JSON.stringify(this[section]));
            this.renderContent(section);
            modalInstance.hide();
            modal.remove();

            if (addedContent.length > 0 || skippedContent.length > 0) {
                let message = '';
                if (addedContent.length > 0) {
                    message += `Agregado: ${addedContent.join(', ')}\n`;
                }
                if (skippedContent.length > 0) {
                    message += `Omitido: ${skippedContent.join(', ')} (duplicados)`;
                }
                this.showToast(message, 'info');
            }
        });
        
        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }

    async extractMetadata(iframeCode) {
        try {
            const parts = iframeCode.split('|').map(part => part.trim());
            let title = parts[0] || '';
            const iframeSrc = parts[1] || iframeCode;

            const qualityMatch = title.match(/\b(?:1080p|720p|2160p|4K|HDR|60FPS|BRRIP|BDRIP|WEB-DL|TELESYNC)\b/i);
            const quality = qualityMatch ? qualityMatch[0].toUpperCase() : '';
            title = title.replace(/\b(?:1080p|720p|2160p|4K|HDR|60FPS|BRRIP|BDRIP|WEB-DL|TELESYNC)\b/gi, '');

            const languageMatch = title.match(/\b(?:Latino[- ]Inglés|Castellano|Dual|Español)\b/i);
            const language = languageMatch ? languageMatch[0] : '';
            title = title.replace(/\b(?:Latino[- ]Inglés|Castellano|Dual|Español)\b/gi, '');

            const yearMatch = title.match(/[\[\(]?(19|20)\d{2}[\]\)]?/);
            const year = yearMatch ? yearMatch[0].replace(/[\[\]()]/g, '') : '';
            title = title.replace(/[\[\(]?(19|20)\d{2}[\]\)]?/, '');

            title = title.replace(/\.(mkv|mp4|avi|mov|flv|wmv)$/i, '');

            title = title.replace(/\b(?:VERSIÓN|VERSION)\s+(?:PESADA|LIGERA|COMPLETA)\b/gi, '')
                        .replace(/\[.*?(?:KARPEZSTUDIO|vip\.hdlatino\.us).*?\]/gi, '')
                        .replace(/cinecalidad(?:\.la)?/gi, '')
                        .replace(/\bx265\b/gi, '')
                        .replace(/full/gi, '')
                        .replace(/\b(?:V\d|LÍNEA|LINE)\b/gi, '');

            title = title.replace(/[\[\(].*?[\]\)]/g, '')
                        .replace(/\./g, ' ')
                        .replace(/\s+/g, ' ')
                        .replace(/[._-]/g, ' ')
                        .trim();

            const searchTitle = title.replace(/\b(?:4K|HDR|EXTENDED|THEATRICAL|CUT|UNRATED)\b/gi, '')
                                    .trim();

            return {
                title: title,
                searchTitle: searchTitle,
                year: year,
                quality: quality,
                language: language,
                iframe: iframeSrc,
                thumbnail: 'https://via.placeholder.com/300x450'
            };
        } catch (error) {
            console.error('Error extracting metadata:', error);
            return null;
        }
    }

    async showMovieSelectionDialog(content) {
        return new Promise(async (resolve) => {
            const searchQuery = encodeURIComponent(content.searchTitle || content.title);
            try {
                const response = await fetch(
                    `${this.TMDB_BASE_URL}/search/movie?api_key=${this.TMDB_API_KEY}&query=${searchQuery}&language=es-ES${content.year ? `&year=${content.year}` : ''}`
                );
                const data = await response.json();

                if (!data.results || data.results.length === 0) {
                    resolve(content);
                    return;
                }

                const modalId = Date.now();
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content bg-dark">
                            <div class="modal-header">
                                <h5 class="modal-title">Seleccionar película correcta para: ${content.title}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    ${data.results.slice(0, 6).map((movie) => `
                                        <div class="col-md-4 mb-3">
                                            <div class="card bg-secondary h-100">
                                                <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" 
                                                    class="card-img-top" 
                                                    alt="${movie.title}"
                                                    onerror="this.src='https://via.placeholder.com/300x450'">
                                                <div class="card-body">
                                                    <h6 class="card-title">${movie.title}</h6>
                                                    <p class="card-text small">
                                                        Año: ${movie.release_date?.substring(0, 4) || 'N/A'}<br>
                                                        Puntuación: ${movie.vote_average}/10
                                                    </p>
                                                    <button class="btn btn-primary btn-sm" 
                                                            onclick="contentManager.selectMovie(${movie.id}, '${modalId}')">
                                                        Seleccionar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="text-center mt-3">
                                    <button class="btn btn-secondary" onclick="contentManager.skipMovieSelection('${modalId}')">
                                        Mantener datos actuales
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                const modalInstance = new bootstrap.Modal(modal);
                
                this.movieSelectionCallbacks = this.movieSelectionCallbacks || {};
                this.movieSelectionCallbacks[modalId] = {
                    resolve,
                    content,
                    modal
                };
                modalInstance.show();
            } catch (error) {
                console.error('Error fetching movie data:', error);
                resolve(content);
            }
        });
    }

    async selectMovie(movieId, modalId) {
        try {
            const response = await fetch(
                `${this.TMDB_BASE_URL}/movie/${movieId}?api_key=${this.TMDB_API_KEY}&append_to_response=credits&language=es-ES`
            );
            const movieData = await response.json();
            
            const metadata = {
                title: movieData.title,
                year: movieData.release_date?.substring(0, 4),
                thumbnail: movieData.poster_path ? 
                          `https://image.tmdb.org/t/p/w500${movieData.poster_path}` : 'https://via.placeholder.com/300x450',
                genres: movieData.genres.map(g => g.name),
                overview: movieData.overview,
                rating: movieData.vote_average,
                runtime: movieData.runtime,
                cast: movieData.credits?.cast?.slice(0, 5).map(actor => actor.name),
                director: movieData.credits?.crew?.find(p => p.job === 'Director')?.name
            };

            const callback = this.movieSelectionCallbacks[modalId];
            if (callback) {
                const modal = callback.modal;
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
                modal.remove();
                callback.resolve(metadata);
                delete this.movieSelectionCallbacks[modalId];
            }
        } catch (error) {
            console.error('Error fetching movie details:', error);
            this.skipMovieSelection(modalId);
        }
    }

    async skipMovieSelection(modalId) {
        const callback = this.movieSelectionCallbacks[modalId];
        if (callback) {
            const modal = callback.modal;
            const modalInstance = bootstrap.Modal.getInstance(modal);
            modalInstance.hide();
            modal.remove();
            callback.resolve(callback.content);
            delete this.movieSelectionCallbacks[modalId];
        }
    }

    cleanTitle(title) {
        return title
            .replace(/\.[^/.]+$/, '')
            .replace(/\b(19|20)\d{2}\b/, '')
            .replace(/\b\d{3,4}p\b/i, '')
            .replace(/\b(dual-lat|latino|castellano)\b/i, '')
            .replace(/\[.*?\]/g, '')
            .replace(/\.(mp4|mkv|avi)$/i, '')
            .replace(/\./g, ' ')
            .replace(/\s+/g, ' ')
            .replace(/cinecalidad(\.la)?/i, '')
            .trim();
    }

    normalizeTitle(title) {
        if (!title) return '';
        return title
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "") 
            .replace(/[^a-z0-9\s]/g, "") 
            .replace(/\s+/g, " ") 
            .trim();
    }

    getSectionName(section) {
        const names = {
            movies: 'Película',
            series: 'Serie',
            music: 'Música',
            photos: 'Foto'
        };
        return names[section] || section;
    }

    showSection(sectionId) {
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
        });
        const targetSection = document.querySelector(`#${sectionId}-section`);
        if (targetSection) {
            targetSection.style.display = 'block';
        }
    }

    renderContent(section) {
        const container = document.querySelector(`#${section}-section .row`);
        const items = this[section] || [];
        
        if (this.currentFilter.section === section && this.currentFilter.type !== 'all') {
            container.insertAdjacentHTML('beforebegin', `
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    Filtro activo: ${this.currentFilter.type === 'incomplete' ? 'Metadata incompleta' : 
                                    `${this.currentFilter.type}: ${this.currentFilter.value}`}
                    <button type="button" class="btn-close" 
                            onclick="contentManager.filterContent('${section}', 'all')"></button>
                </div>
            `);
        }
        
        if (items.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info w-100">
                    <i class="fas fa-info-circle me-2"></i>No hay ${section === 'movies' ? 'películas' : 'series'} disponibles.
                </div>
            `;
            return;
        }

        if (section === 'series') {
            const seriesGroups = this.groupSeriesByName(items);
            container.innerHTML = `
                <div class="row g-4">
                    ${Object.entries(seriesGroups).map(([seriesName, episodes]) => {
                        const firstEpisode = episodes[0]; 
                        return `
                            <div class="col-md-3 mb-4">
                                <div class="media-card" onclick="contentManager.showSeriesEpisodes('${seriesName}')">
                                    <div class="media-thumbnail" style="background-image: url('${firstEpisode.thumbnail || 'https://via.placeholder.com/300x450'}')">
                                        <div class="media-overlay">
                                            <h5 class="text-truncate">${seriesName}</h5>
                                            ${firstEpisode.year ? `<p>Año: ${firstEpisode.year}</p>` : ''}
                                            ${firstEpisode.genres ? `<p>Géneros: ${firstEpisode.genres.slice(0, 2).join(', ')}${firstEpisode.genres.length > 2 ? '...' : ''}</p>` : ''}
                                            <p>Episodios: ${episodes.length}</p>
                                        </div>
                                        <div class="media-actions">
                                            <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); contentManager.editSeries('${seriesName}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); contentManager.deleteSeries('${seriesName}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="row g-4">
                    ${items.map((item, index) => `
                        <div class="col-md-3 mb-4">
                            <div class="media-card" onclick="contentManager.playContent('${section}', ${index})">
                                <div class="media-thumbnail" style="background-image: url('${item.thumbnail || 'https://via.placeholder.com/300x450'}')">
                                    <div class="media-overlay">
                                        <h5 class="text-truncate">${item.title}</h5>
                                        ${item.year ? `<p>Año: ${item.year}</p>` : ''}
                                        ${item.genres ? `<p>Géneros: ${item.genres.slice(0, 2).join(', ')}${item.genres.length > 2 ? '...' : ''}</p>` : ''}
                                    </div>
                                    <div class="media-actions">
                                        <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); contentManager.editContent('${section}', ${index})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); contentManager.deleteContent('${section}', ${index})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    }

    renderSeasonAccordion(episodes) {
        const seasonGroups = episodes.reduce((groups, episode) => {
            const season = episode.season || '1';
            if (!groups[season]) {
                groups[season] = [];
            }
            groups[season].push(episode);
            return groups;
        }, {});

        return Object.entries(seasonGroups).map(([season, seasonEpisodes], index) => `
            <div class="accordion-item bg-dark">
                <h2 class="accordion-header">
                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'} bg-secondary text-light" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#season${season}">
                        Temporada ${season}
                    </button>
                </h2>
                <div id="season${season}" 
                     class="accordion-collapse collapse ${index === 0 ? 'show' : ''}"
                     data-bs-parent="#episodeAccordion">
                    <div class="accordion-body">
                        <div class="list-group list-group-flush">
                            ${seasonEpisodes.map((episode, idx) => `
                                <div class="list-group-item bg-dark text-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>Episodio ${episode.episode}</span>
                                        <div class="btn-group">
                                            <button class="btn btn-primary btn-sm" onclick="contentManager.playContent('series', ${this.series.indexOf(episode)})">
                                                <i class="fas fa-play"></i> Reproducir
                                            </button>
                                            <button class="btn btn-warning btn-sm" onclick="contentManager.editContent('series', ${this.series.indexOf(episode)})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="contentManager.deleteContent('series', ${this.series.indexOf(episode)})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    groupSeriesByName(series) {
        return series.reduce((groups, episode) => {
            if (!groups[episode.seriesName]) {
                groups[episode.seriesName] = [];
            }
            groups[episode.seriesName].push(episode);
            return groups;
        }, {});
    }

    playContent(section, index) {
        const item = this[section][index];
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            ${item.title || item.seriesName}
                            ${item.year ? ` (${item.year})` : ''}
                            ${item.quality ? ` - ${item.quality}` : ''}
                            ${item.language ? ` - ${item.language}` : ''}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="ratio ratio-16x9" style="min-height: 600px;">
                            ${this.createIframe(item.iframe)}
                        </div>
                        ${item.genres ? `
                            <div class="p-3">
                                <small class="text-muted">
                                    Géneros: ${item.genres.join(', ')}
                                </small>
                            </div>
                        ` : ''}
                        <div class="p-3 border-top">
                            <button class="btn btn-secondary btn-sm" onclick="contentManager.scanLibrary('${section}', ${index})">
                                <i class="fas fa-sync me-2"></i>Actualizar Metadata
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }

    createIframe(iframeUrl) {
        if (iframeUrl.toLowerCase().includes('<iframe')) {
            return iframeUrl;
        }
        return `<iframe src="${iframeUrl}" 
                        allowfullscreen="true"
                        frameborder="0" 
                        scrolling="no" 
                        style="width: 100%; height: 100%;"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                </iframe>`;
    }

    async scanLibrary(section, specificIndex = null) {
        const selectionModal = document.createElement('div');
        selectionModal.className = 'modal fade';
        
        const itemsToShow = specificIndex !== null ? 
            [this[section][specificIndex]].map((item, idx) => ({item, index: specificIndex})) :
            this[section].map((item, idx) => ({item, index: idx}));

        selectionModal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">Seleccionar contenido para actualizar</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Selecciona las películas que deseas actualizar
                        </div>
                        <form id="updateSelectionForm">
                            ${itemsToShow.map(({item, index}) => `
                                <div class="form-check mb-3 bg-secondary p-3 rounded">
                                    <input class="form-check-input" type="checkbox" id="item${index}" 
                                        name="selectedItems" value="${index}"
                                        ${(!item.genres || !item.overview || !item.rating) ? 'checked' : ''}>
                                    <label class="form-check-label w-100" for="item${index}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">${item.title || item.seriesName}</h6>
                                                <small class="text-muted">
                                                    ${item.year ? `Año: ${item.year}` : 'Sin año'} |
                                                    ${item.genres ? `Géneros: ${item.genres.join(', ')}` : 'Sin géneros'} |
                                                    ${item.rating ? `Rating: ${item.rating}` : 'Sin rating'}
                                                </small>
                                            </div>
                                            ${item.thumbnail ? `
                                                <img src="${item.thumbnail}" alt="${item.title}" style="width: 50px; height: 75px; object-fit: cover;" class="rounded">
                                            ` : ''}
                                        </div>
                                    </label>
                                </div>
                            `).join('')}
                            <div class="mt-3 text-center">
                                <button type="submit" class="btn btn-primary">Actualizar seleccionados</button>
                                <button type="button" class="btn btn-secondary ms-2" data-bs-dismiss="modal">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(selectionModal);
        const modalInstance = new bootstrap.Modal(selectionModal);
        modalInstance.show();

        const form = selectionModal.querySelector('#updateSelectionForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            modalInstance.hide();

            const selectedIndexes = Array.from(new FormData(form).getAll('selectedItems')).map(Number);
            if (selectedIndexes.length === 0) {
                this.showToast('No se seleccionó ningún elemento para actualizar', 'info');
                return;
            }

            const loadingToast = this.showToast('Escaneando biblioteca...', 'info');
            const items = this[section];
            let updated = false;
            let updatedCount = 0;

            for (const index of selectedIndexes) {
                const item = items[index];
                try {
                    const searchQuery = encodeURIComponent(item.title || item.seriesName);
                    const type = section === 'series' ? 'tv' : 'movie';
                    const response = await fetch(
                        `${this.TMDB_BASE_URL}/search/${type}?api_key=${this.TMDB_API_KEY}&query=${searchQuery}&language=es-ES`
                    );
                    const data = await response.json();

                    if (data.results && data.results.length > 0) {
                        await this.showUpdateApprovalModal(items, index, data.results, type);
                        updated = true;
                        updatedCount++;
                    }
                } catch (error) {
                    console.error(`Error updating metadata for ${item.title}:`, error);
                }

                this.updateToast(loadingToast, `Escaneando biblioteca... (${updatedCount}/${selectedIndexes.length})`);
            }

            if (updated) {
                localStorage.setItem(section, JSON.stringify(items));
                this.renderContent(section);
                this.showToast(`Actualización completada. Se actualizaron ${updatedCount} elementos.`, 'success');
            } else {
                this.showToast('No se encontraron actualizaciones necesarias.', 'info');
            }
            
            loadingToast.hide();
        });

        selectionModal.addEventListener('hidden.bs.modal', () => {
            selectionModal.remove();
        });
    }

    async showUpdateApprovalModal(items, index, results, type) {
        return new Promise((resolve) => {
            const item = items[index];
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content bg-dark">
                        <div class="modal-header">
                            <h5 class="modal-title">Actualizar metadata para: ${item.title || item.seriesName}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                ${results.slice(0, 5).map((result, idx) => `
                                    <div class="col-md-4 mb-3">
                                        <div class="card bg-secondary h-100">
                                            <img src="https://image.tmdb.org/t/p/w500${result.poster_path}" 
                                                 class="card-img-top" 
                                                 alt="${result.title || result.name}"
                                                 onerror="this.src='https://via.placeholder.com/300x450'">
                                            <div class="card-body">
                                                <h6 class="card-title">${result.title || result.name}</h6>
                                                <p class="card-text small">
                                                    Año: ${result.release_date?.substring(0, 4) || result.first_air_date?.substring(0, 4) || 'N/A'}<br>
                                                    Puntuación: ${result.vote_average}/10
                                                </p>
                                                <button class="btn btn-primary btn-sm" 
                                                        onclick="contentManager.approveUpdate(${index}, ${result.id}, '${type}')">
                                                    Seleccionar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Mantener actual</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();

            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
                resolve();
            });
        });
    }

    async approveUpdate(itemIndex, tmdbId, type) {
        try {
            const details = await this.fetchAdditionalDetails(tmdbId, type);
            const section = type === 'tv' ? 'series' : 'movies';
            const items = this[section];
            
            items[itemIndex] = {
                ...items[itemIndex],
                title: type === 'tv' ? details.name : details.title,
                year: details.release_date?.substring(0, 4) || details.first_air_date?.substring(0, 4),
                thumbnail: details.poster_path ? 
                          `https://image.tmdb.org/t/p/w500${details.poster_path}` : items[itemIndex].thumbnail,
                genres: details.genres.map(g => g.name),
                overview: details.overview,
                rating: details.vote_average,
                runtime: details.runtime,
                cast: details.credits?.cast?.slice(0, 5).map(actor => actor.name),
                director: details.credits?.crew?.find(p => p.job === 'Director')?.name
            };

            localStorage.setItem(section, JSON.stringify(items));
            this.renderContent(section);
            
            const modal = document.querySelector('.modal');
            const modalInstance = bootstrap.Modal.getInstance(modal);
            modalInstance.hide();
            
            this.showToast('Metadata actualizada correctamente', 'success');
        } catch (error) {
            console.error('Error updating metadata:', error);
            this.showToast('Error al actualizar metadata', 'error');
        }
    }

    async fetchAdditionalDetails(id, type) {
        try {
            const response = await fetch(
                `${this.TMDB_BASE_URL}/${type}/${id}?api_key=${this.TMDB_API_KEY}&append_to_response=credits&language=es-ES`
            );
            return await response.json();
        } catch (error) {
            console.error('Error fetching additional details:', error);
            return {};
        }
    }

    deleteContent(section, index) {
        const item = this[section][index];
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmar eliminación</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>¿Estás seguro de que deseas eliminar "${item.title || item.seriesName}"?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger" onclick="contentManager.confirmDelete('${section}', ${index})">
                            Eliminar
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }

    confirmDelete(section, index) {
        this[section].splice(index, 1);
        localStorage.setItem(section, JSON.stringify(this[section]));
        this.renderContent(section);
        
        const modal = document.querySelector('.modal');
        const modalInstance = bootstrap.Modal.getInstance(modal);
        modalInstance.hide();
        
        this.showToast('Contenido eliminado correctamente', 'success');
    }

    deleteSeries(seriesName) {
        this.series = this.series.filter(episode => episode.seriesName !== seriesName);
        localStorage.setItem('series', JSON.stringify(this.series));
        this.renderContent('series');
        
        const modal = document.querySelector('.modal');
        const modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }
        
        this.showToast('Serie eliminada correctamente', 'success');
    }

    editSeries(seriesName) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Serie: ${seriesName}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editSeriesForm">
                            <div class="mb-3">
                                <label class="form-label">Nombre de la Serie</label>
                                <input type="text" class="form-control bg-secondary text-light" 
                                       name="seriesName" value="${seriesName}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Imagen de la Serie (thumbnail)</label>
                                <input type="url" class="form-control bg-secondary text-light" 
                                       name="thumbnail" value="${this.series.find(s => s.seriesName === seriesName)?.thumbnail || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Géneros (separados por comas)</label>
                                <input type="text" class="form-control bg-secondary text-light" 
                                       name="genres" value="${this.series.find(s => s.seriesName === seriesName)?.genres?.join(', ') || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Descripción</label>
                                <textarea class="form-control bg-secondary text-light" 
                                      name="overview" rows="3">${this.series.find(s => s.seriesName === seriesName)?.overview || ''}</textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Guardar cambios</button>
                        </form>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

        const form = modal.querySelector('#editSeriesForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const newSeriesName = formData.get('seriesName');
            
            this.series.forEach((episode, index) => {
                if (episode.seriesName === seriesName) {
                    this.series[index] = {
                        ...episode,
                        seriesName: newSeriesName,
                        thumbnail: formData.get('thumbnail'),
                        genres: formData.get('genres').split(',').map(g => g.trim()).filter(g => g),
                        overview: formData.get('overview')
                    };
                }
            });

            localStorage.setItem('series', JSON.stringify(this.series));
            this.renderContent('series');
            modalInstance.hide();
            this.showToast('Serie actualizada correctamente', 'success');
        });

        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }

    showSeriesEpisodes(seriesName) {
        const episodes = this.series.filter(ep => ep.seriesName === seriesName);
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">${seriesName}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="accordion" id="episodeAccordion">
                            ${this.renderSeasonAccordion(episodes)}
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }

    showToast(message, type = 'info') {
        const toastContainer = document.querySelector('.toast-container') || (() => {
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        })();

        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        toastContainer.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 3000 });
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
        
        return bsToast;
    }

    updateToast(toast, message) {
        if (toast) {
            const toastBody = toast._element.querySelector('.toast-body');
            if (toastBody) {
                toastBody.textContent = message;
            }
        }
    }

    async editContent(section, index) {
        const item = this[section][index];
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar ${section === 'movies' ? 'Película' : 'Serie'}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editContentForm">
                            <div class="mb-3">
                                <label class="form-label">Título</label>
                                <input type="text" class="form-control bg-secondary text-light" 
                                       name="title" value="${item.title || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Año</label>
                                <input type="text" class="form-control bg-secondary text-light" 
                                       name="year" value="${item.year || ''}" pattern="\\d{4}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Calidad</label>
                                <input type="text" class="form-control bg-secondary text-light" 
                                       name="quality" value="${item.quality || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Idioma</label>
                                <input type="text" class="form-control bg-secondary text-light" 
                                       name="language" value="${item.language || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">URL Imagen (thumbnail)</label>
                                <input type="url" class="form-control bg-secondary text-light" 
                                       name="thumbnail" value="${item.thumbnail || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Géneros (separados por comas)</label>
                                <input type="text" class="form-control bg-secondary text-light" 
                                       name="genres" value="${item.genres ? item.genres.join(', ') : ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Descripción</label>
                                <textarea class="form-control bg-secondary text-light" 
                                          name="overview" rows="3">${item.overview || ''}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Rating</label>
                                <input type="number" step="0.1" min="0" max="10" 
                                       class="form-control bg-secondary text-light" 
                                       name="rating" value="${item.rating || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Código iframe</label>
                                <textarea class="form-control bg-secondary text-light" 
                                          name="iframe" rows="3" required>${item.iframe || ''}</textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Guardar cambios</button>
                        </form>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

        const form = modal.querySelector('#editContentForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            
            this[section][index] = {
                ...item,
                title: formData.get('title'),
                year: formData.get('year'),
                quality: formData.get('quality'),
                language: formData.get('language'),
                thumbnail: formData.get('thumbnail'),
                genres: formData.get('genres').split(',').map(g => g.trim()).filter(g => g),
                overview: formData.get('overview'),
                rating: formData.get('rating'),
                iframe: formData.get('iframe')
            };

            localStorage.setItem(section, JSON.stringify(this[section]));
            this.renderContent(section);
            modalInstance.hide();
            this.showToast('Contenido actualizado correctamente', 'success');
        });

        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }

    sortContent(section, field, direction) {
        this.currentSort = { section, field, direction };
        const items = [...this[section]];
        
        items.sort((a, b) => {
            let valueA = (a[field] || '').toString().toLowerCase();
            let valueB = (b[field] || '').toString().toLowerCase();
            
            if (field === 'year' || field === 'rating') {
                valueA = parseFloat(valueA) || 0;
                valueB = parseFloat(valueB) || 0;
            }
            
            if (direction === 'asc') {
                return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
            } else {
                return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
            }
        });
        
        this[section] = items;
        this.renderContent(section);
    }

    filterContent(section, type, value = null) {
        this.currentFilter = { section, type, value };
        const items = JSON.parse(localStorage.getItem(section) || '[]');
        
        let filtered = items;
        if (type === 'incomplete') {
            filtered = items.filter(item => !item.genres || !item.overview || !item.rating);
        } else if (type === 'quality') {
            filtered = items.filter(item => 
                item.quality && item.quality.toLowerCase().includes(value.toLowerCase())
            );
        } else if (type === 'language') {
            filtered = items.filter(item => 
                item.language && item.language.toLowerCase().includes(value.toLowerCase())
            );
        }
        
        this[section] = filtered;
        this.renderContent(section);
        
        if (filtered.length === 0) {
            this.showToast('No se encontraron elementos con los filtros aplicados', 'info');
        }
    }
}

// Initialize content manager
const contentManager = new ContentManager();
</script></body></html>